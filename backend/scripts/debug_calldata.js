const { ethers } = require('ethers');

const AEQUI_EXECUTOR_ABI = [
    "function execute((address token, uint256 amount)[] pulls, (address token, address spender, uint256 amount)[] approvals, (address target, uint256 value, bytes data, address injectToken, uint256 injectOffset)[] calls, address[] tokensToFlush) payable returns (bytes[] results)"
];

const UNISWAP_V3_ROUTER_ABI = [
    "function exactInputSingle((address tokenIn, address tokenOut, uint24 fee, address recipient, uint256 deadline, uint256 amountIn, uint256 amountOutMinimum, uint160 sqrtPriceLimitX96)) payable returns (uint256 amountOut)"
];

const UNISWAP_V2_ROUTER_ABI = [
    "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) returns (uint[] memory amounts)"
];

const data = "0x83fcf4b7000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000fff9976782d46cc05630d1f6ebab18b2324d6b14000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000aa8e23fb1079ea71e0a56f48a2aa51851d8433d00000000000000000000000003bfa4769fb09eefc5a80d6e87c3b9c650f7ae48effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000ee567fe1712faf6149d80da1e6934e354124cfe3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010438ed1739000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000000000000000000168dc3c00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000ca9c2ce48cd0a89287762c30d76d6417888204d700000000000000000000000000000000000000000000000000000000697baabe0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000fff9976782d46cc05630d1f6ebab18b2324d6b14000000000000000000000000aa8e23fb1079ea71e0a56f48a2aa51851d8433d0000000000000000000000000000000000000000000000000000000000000000000000000000000003bfa4769fb09eefc5a80d6e87c3b9c650f7ae48e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000aa8e23fb1079ea71e0a56f48a2aa51851d8433d000000000000000000000000000000000000000000000000000000000000000c40000000000000000000000000000000000000000000000000000000000000104414bf389000000000000000000000000aa8e23fb1079ea71e0a56f48a2aa51851d8433d00000000000000000000000001c7d4b196cb0c7b01d743fbc6116a902379c72380000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000cc519ae1c21bbb83c4b9d08ff066bc263e9c1a7e00000000000000000000000000000000000000000000000000000000697baabe0000000000000000000000000000000000000000000000000000000001687fdb000000000000000000000000000000000000000000000000000000000002e0ac0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000fff9976782d46cc05630d1f6ebab18b2324d6b14000000000000000000000000aa8e23fb1079ea71e0a56f48a2aa51851d8433d0";

const iface = new ethers.Interface(AEQUI_EXECUTOR_ABI);
const decoded = iface.decodeFunctionData('execute', data);

console.log("Pulls:", decoded.pulls.map(p => ({ token: p.token, amount: p.amount.toString() })));
console.log("Approvals:", decoded.approvals.map(a => ({ token: a.token, spender: a.spender, amount: a.amount.toString() })));
console.log("Calls:");
decoded.calls.forEach((c, i) => {
    console.log(`  Call ${i}:`);
    console.log(`    Target: ${c.target}`);
    console.log(`    Value: ${c.value.toString()}`);
    console.log(`    Inject: ${c.injectToken} at ${c.injectOffset}`);

    // Try to decode inner data
    try {
        if (c.target.toLowerCase() === '0x3bfa4769fb09eefc5a80d6e87c3b9c650f7ae48e') {
            const v3Iface = new ethers.Interface(UNISWAP_V3_ROUTER_ABI);
            const v3Decoded = v3Iface.decodeFunctionData('exactInputSingle', c.data);
            const params = v3Decoded[0];
            console.log(`    V3 Data:`, {
                tokenIn: params[0],
                tokenOut: params[1],
                fee: params[2].toString(),
                recipient: params[3],
                deadline: params[4].toString(),
                amountIn: params[5].toString(),
                minOut: params[6].toString()
            });
        } else {
            const v2Iface = new ethers.Interface(UNISWAP_V2_ROUTER_ABI);
            const v2Decoded = v2Iface.decodeFunctionData('swapExactTokensForTokens', c.data);
            console.log(`    V2 Data:`, {
                amountIn: v2Decoded.amountIn.toString(),
                path: v2Decoded.path,
                deadline: v2Decoded.deadline.toString()
            });
        }
    } catch (e) {
        console.log(`    Inner Data: ${c.data.slice(0, 100)}... (Failed to decode: ${e.message})`);
    }
});
